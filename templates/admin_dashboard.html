<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
  </head>
  <body>
    {% include '_flashes.html' %}

    <h1>Admin Dashboard</h1>
    <p>
      Welcome, {{ current_user.full_name }}! |
      <a href="{{ url_for('logout') }}">Logout</a>
    </p>

    <hr />

    <h2>Manage Parking Lots</h2>
    <a href="{{ url_for('add_lot') }}">Add a New Parking Lot</a>
    <h3>Existing Lots:</h3>
    {% for lot in lots %}
    <div style="border: 1px solid black; padding: 10px; margin-bottom: 10px">
      <a
        href="{{ url_for('edit_lot', lot_id=lot.id) }}"
        style="margin-right: 10px"
        >Edit</a
      >

      <form
        method="POST"
        action="{{ url_for('delete_lot', lot_id=lot.id) }}"
        style="display: inline-block"
        onsubmit="return confirm('Are you sure you want to delete this lot?');"
      >
        <input type="submit" value="Delete Lot" />
      </form>

      <h4>{{ lot.prime_location_name }} ({{ lot.pin_code }})</h4>
      <ul>
        <li>Address: {{ lot.address }}</li>
        <li>Price per unit time: ${{ lot.price }}</li>
        <li>Capacity: {{ lot.maximum_number_of_spots }} spots</li>
      </ul>

      <strong>Parking Spots Status:</strong>
      <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px">
        {% for spot in lot.spots %}
        <span
          style="border: 1px solid green; padding: 5px; background-color: {{ 'lightgreen' if spot.status == 'A' else 'lightcoral'}};"
        >
          Spot {{ spot.spot_number }} - {% if spot.status == 'A' %}Available{%
          else %}Occupied{% endif %}
        </span>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <p>No parking lots have been created yet.</p>
    {% endfor %}

    <hr />

    <h2>Registered Users</h2>
    <table border="1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
        </tr>
      </thead>
      <tbody>
    {% for user in users %}
    <tr>
        <td>{{ user.id }}</td>
        <td>{{ user.full_name }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.role }}</td>
        <td>
            {% if user.role == 'User' %}
                <a href="{{ url_for('admin_view_user_history', user_id=user.id) }}">View History</a>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</tbody>
    </table>

    <hr />

    <h2>All Parking Records</h2>
    <table border="1">
      <thead>
        <tr>
          <th>User</th>
          <th>Lot</th>
          <th>Spot</th>
          <th>Parked At</th>
          <th>Left At</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for res in reservations %}
        <tr>
          <td>{{ res.user.full_name }} ({{ res.user.username }})</td>
          <td>{{ res.spot.lot.prime_location_name }}</td>
          <td>{{ res.spot.spot_number }}</td>
          <td>{{ res.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            {% if res.leaving_timestamp %} {{
            res.leaving_timestamp.strftime('%Y-%m-%d %H:%M') }} {% else %}
            Currently Parked {% endif %}
          </td>
          <td>
            {% if res.leaving_timestamp %} Completed {% else %} Active {% endif
            %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6">No parking records found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>


  </body>
</html>
